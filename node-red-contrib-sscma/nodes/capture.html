<script type="text/html" data-template-name="capture">
    <div class="form-row">
        <label for="node-input-name">
            <i class="fa fa-tag"></i>
            Label
        </label>
        <input type="text" id="node-input-name" />
    </div>
    <div class="form-row">
        <label for="node-input-client">
            <i class="fa fa-globe"></i>
            Client
        </label>
        <input type="text" id="node-input-client" />
    </div>
    <div class="form-row">
        <label for="node-input-storage">
            <i class="fa fa-folder"></i>
            Storage
        </label>
        <select id="node-input-storage">
            <option value="local" selected>Local(/userdata/Images)</option>
            <option value="external">External (SD Card)</option>
        </select>
    </div>
    <div class="form-row" style="display: flex;">
        <label>
            <i class="fa fa-camera"></i>
            <span id="capture-mode-label">Capture Mode</span>
        </label>
        <div>
            <div style="display: flex; align-items: flex-start; margin-bottom: 5px;">
                <input style="width: auto; margin-right: 10px;" type="radio" name="node-input-capture-mode" value="periodic" />
                <div>
                    <span id="capture-mode-periodic-label">Capture at certain frequency</span>
                    <div id="image-interval" style="margin-top: 5px; color: #666; display: flex; align-items: center;">
                        <span style="margin-right: 8px;">Take 1 photo every</span>
                        <select id="node-input-interval" style="width: 50px;">
                            <option value="2">2</option>
                            <option value="5" selected>5</option>
                            <option value="10">10</option>
                            <option value="30">30</option>
                        </select>
                        <select id="node-input-timeUnit" style="width: auto; margin-left: 5px;">
                            <option value="0">Seconds</option>
                            <option value="1" selected>Minutes</option>
                            <option value="2">Hours</option>
                        </select>
                    </div>
                    <div id="capture-duration" style="margin-top: 5px; color: #666; display: flex; align-items: center;">
                        <span style="margin-right: 8px;">Duration:</span>
                        <input type="number" id="node-input-duration" min="0" placeholder="Enter 0 for indefinite" style="width: 60px;" />
                        <select id="node-input-durationUnit" style="width: auto; margin-left: 5px;">
                            <option value="0">Seconds</option>
                            <option value="1" selected>Minutes</option>
                            <option value="2">Hours</option>
                        </select>
                    </div>
                </div>
            </div>
            <div style="display: flex;">
                <input style="width: auto; margin: 0 10px 0 0;" type="radio" name="node-input-capture-mode" value="trigger" />
                <span id="capture-mode-trigger-label">Control by message</span>
            </div>
            <div id="trigger-msg-tips" style="margin-left: 24px; color: #888;">Take 1 photo when msg.enable is true or msg.payload = "capture"</div>
        </div>
    </div>

    <div class="form-row" style="display: flex;">
        <label>
            <i class="fa fa-toggle-on"></i>
            <span id="start-label">Start</span>
        </label>
        <div>
            <div style="display: flex; margin-bottom: 5px;">
                <input style="width: auto; margin: 0 10px 0 0;" type="radio" name="node-input-start-mode" value="immediate" />
                <span id="start-radio-immediate-label">Start immediately when deploy</span>
            </div>
            <div style="display: flex;">
                <input style="width: auto; margin: 0 10px 0 0;" type="radio" name="node-input-start-mode" value="msg" />
                <span id="start-radio-msg-label">Control by msg.enable</span>
            </div>
            <div id="start-msg-tips" style="margin-left: 24px; color: #888;">
                When msg.enable is true, the capture starts.
                <br />
                When msg.enable is false, the capture stops.
            </div>
        </div>
    </div>
    <div class="form-row" id="manual-mode-info" style="display: block;">
        <div class="form-tips">
            <i class="fa fa-info-circle"></i>
            You can also send msg.payload = "capture" to take one photo
        </div>
    </div>
</script>
<script type="text/javascript">
    RED.nodes.registerType("capture", {
        category: "Vision AI",
        color: "#D9A066",
        defaults: {
            name: { value: this.name || "capture image" },
            interval: { value: "5" },
            timeUnit: { value: "1" },
            storage: { value: "local" },
            duration: { value: 0 }, // Default duration (0 means indefinite)
            durationUnit: { value: "1" }, // Default duration unit (1 means minutes)
            captureMode: { value: "periodic" }, // periodic or trigger
            startMode: { value: "immediate" }, // immediate or msg
            client: { type: "sscma", required: true, label: RED._("sscma") },
        },
        inputs: 1,
        outputs: 0,
        icon: "font-awesome/fa-camera",
        label: function () {
            return this.name || "capture";
        },
        oneditprepare: function () {
            var defaultImageName = "capture image";
            var $nameInput = $("#node-input-name");
            var userModifiedName = false;
            $nameInput.on("input", function () {
                var v = $(this).val();
                userModifiedName = !(v === "" || v === defaultImageName);
            });
            if (!userModifiedName && $nameInput.val() === "") {
                $nameInput.val(defaultImageName);
            }

            // Ensure capture mode radio has a default selection
            var captureMode = (this.captureMode && (this.captureMode === "periodic" || this.captureMode === "trigger")) ? this.captureMode : "periodic";
            $(`input[name="node-input-capture-mode"][value="${captureMode}"]`).prop("checked", true);

            // Ensure start mode radio has a default selection
            var startMode = (this.startMode && (this.startMode === "immediate" || this.startMode === "msg")) ? this.startMode : "immediate";
            $(`input[name="node-input-start-mode"][value="${startMode}"]`).prop("checked", true);

            function updateIntervalControlsEnablement() {
                var isTriggered = $("input[name='node-input-capture-mode'][value='trigger']").is(":checked");
                $("#node-input-interval").prop("disabled", isTriggered);
                $("#node-input-timeUnit").prop("disabled", isTriggered);
                $("#node-input-duration").prop("disabled", isTriggered);
                $("#node-input-durationUnit").prop("disabled", isTriggered);
            }
            $("input[name='node-input-capture-mode']").on("change", function () {
                updateIntervalControlsEnablement();
            });
            updateIntervalControlsEnablement();
        },
        oneditcancel: function () {
            $(`input[name="node-input-capture-mode"][value="${this.captureMode}"]`).prop("checked", true);
            $(`input[name="node-input-start-mode"][value="${this.startMode}"]`).prop("checked", true);
        },
        oneditsave: function () {
            this.captureMode = $("input[name='node-input-capture-mode']:checked").val();
            this.startMode = $("input[name='node-input-start-mode']:checked").val();
        },
    });
    RED.events.on("nodes:add", function (node) {
        const existingNodes = RED.nodes.filterNodes({ type: "capture" });
        if (existingNodes.length > 1) {
            RED.notify("This node can only be instantiated once.", "error");
            RED.nodes.remove(node.id);
        }
    });
</script>
<script type="text/markdown" data-help-name="capture">
This is the `Capture Image` node for Seeed SenseCraft Model Assistant such as reCamera or Pi camera.

### Input

Wire the camera node to the capture image node to enable capturing.

### Parameters

#### Configuration

Please select sscma for the client.

#### Storage

-   **Local**: path: `/userdata/Images`
-   **External**: Stored in SD card.

#### Capture Mode

-   **Capture at certain frequency**: Take one photo periodically based on interval and duration
-   **Control by message**: Take one photo when `msg.enable` is true or `msg.payload = "capture"`

#### Start

Start immediately on deploy or control by message `msg.enable`.

#### Interval

Time interval between saved images. You can change units in the dropdown menu. Only available in periodic mode.

#### Duration

Total time length of the capture session. You can change units in the dropdown menu. Set to 0 for indefinite capture. Only available in periodic mode.

**Example**: if interval is set to 5 minutes and duration is set to 1 hour, 12 photos will be captured (one every 5 minutes for 1 hour).

#### Manual capture

Send a message with `msg.payload = "capture"` to take one photo.
</script>
