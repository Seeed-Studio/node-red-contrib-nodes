<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Base64 Image on Canvas</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }

        .canvas-container {
            margin-top: 20px;
            border: 4px solid green;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            display: block;
        }
    </style>
</head>

<body>
    <div class="canvas-container">
        <canvas id="drawing-canvas"></canvas>
    </div>

    <script>

        const COLORS = [
            '#FF0000',
            '#FFA500',
            '#FFFF00',
            '#32CD32',
            '#006400',
            '#4169E1',
            '#0000FF',
            '#FF1493',
            '#FFC0CB',
            '#800080',
            '#FFD700',
            '#9ACD32',
            '#ADFF2F',
            '#00FFFF',
            '#1E90FF',
            '#FF4500',
            '#CD853F',
            '#FF8C00',
            '#FF6347',
            '#8B4513',
            '#FF69B4',
            '#FF00FF',
            '#BA55D3',
            '#9400D3',
            '#8A2BE2',
            '#4682B4',
            '#87CEEB',
            '#00CED1',
            '#20B2AA',
            '#FFB6C1',
            '#696969',
            '#808080',
            '#A9A9A9',
            '#C0C0C0',
            '#D3D3D3',
            '#FFFAFA',
            '#F0FFF0',
            '#F5F5DC',
            '#FFE4C4',
            '#FFDAB9',
            '#EEE8AA',
            '#F0E68C',
            '#BDB76B',
            '#FFD700',
            '#F5DEB3',
            '#D2B48C',
            '#DEB887',
            '#BC8F8F',
            '#F4A460',
            '#DAA520',
            '#CD853F',
            '#A52A2A',
            '#8B4513',
            '#D2691E',
            '#B22222',
            '#FF6347',
            '#FF4500',
            '#FF8C00',
            '#FFA07A',
            '#FA8072',
            '#E9967A',
            '#FF69B4',
            '#FF1493',
            '#DB7093',
            '#C71585',
        ];

        const url = window.location.pathname;
        const nodeId = url.split('/').pop();
        const source = new EventSource(`/preview-data/${nodeId}`);

        // 获取画布和上下文
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        // 创建一个Image对象
        const img = new Image();
        var count = 0;

        source.onmessage = function (event) {
            const msg = JSON.parse(event.data);
            const data = msg.payload.data;
            if (data?.image) {
                const image = data.image;
                img.onload = () => {

                    canvas.width = img.height;
                    canvas.height = img.width;
                    if (data?.rotate) {
                        const rotate = data.rotate;
                        console.log(rotate);
                        if (rotate === 0) {
                            ctx.drawImage(img, 0, 0, img.width, img.height);
                        }
                        if (rotate === 90) {
                            ctx.translate(canvas.value.width / 2, canvas.value.height / 2);
                            ctx.rotate((90 * Math.PI) / 180);
                            ctx.drawImage(
                                img,
                                -canvas.value.height / 2,
                                -canvas.value.width / 2,
                                canvas.value.height,
                                canvas.value.width
                            );
                            ctx.setTransform(1, 0, 0, 1, 0, 0);
                        }
                        if (rotate === 180) {
                            ctx.translate(canvas.value.width / 2, canvas.value.height / 2);
                            ctx.rotate((180 * Math.PI) / 180);
                            ctx.drawImage(
                                img,
                                -canvas.value.width / 2,
                                -canvas.value.height / 2,
                                canvas.value.width,
                                canvas.value.height
                            );
                            ctx.setTransform(1, 0, 0, 1, 0, 0);
                        }
                        if (rotate === 270) {
                            ctx.translate(canvas.value.width / 2, canvas.value.height / 2);
                            ctx.rotate((270 * Math.PI) / 180);
                            ctx.drawImage(
                                img,
                                -canvas.value.height / 2,
                                -canvas.value.width / 2,
                                canvas.value.height,
                                canvas.value.width
                            );
                            ctx.setTransform(1, 0, 0, 1, 0, 0);
                        }
                    } else {
                        ctx.drawImage(img, 0, 0, img.width, img.height);
                    }

                    if (data?.boxes) {
                        const boxes = data.boxes;
                        for (let i = 0; i < boxes.length; i += 1) {
                            const rect = boxes[i];
                            if (rect?.length === 6) {
                                const x = rect[0];
                                const y = rect[1];
                                const w = rect[2];
                                const h = rect[3];
                                const score = rect[4];
                                const tar = parseInt(rect[5], 10);
                                const color = COLORS[tar % COLORS.length];
                                let tarStr = '';
                                tarStr = tar.toString();
                                ctx.strokeStyle = color;
                                ctx.lineWidth = 2;
                                ctx.strokeRect(x - w / 2, y - h / 2, w, h);
                                ctx.fillStyle = color;
                                ctx.fillRect(x - w / 2, y - h / 2 - 12, w, 12);
                                ctx.font = 'bold 12px arial';
                                ctx.fillStyle = '#ffffff';
                                ctx.fillText(`${tarStr}: ${score}`, x - w / 2 + 5, y - h / 2 - 2);
                            }
                        }
                    }
                    if (data?.classes) {
                        const tagets = data.classes;
                        for (let i = 0; i < tagets.length; i += 1) {
                            const tar = tagets[i][1];
                            const score = tagets[i][0];
                            let tarStr = '';
                            tarStr = tar.toString();
                            ctx.globalAlpha = 0.3;
                            ctx.fillStyle = COLORS[tar % COLORS.length];
                            ctx.fillRect(
                                (canvas.value.width / tagets.length) * i,
                                0,
                                (canvas.value.width / tagets.length) * (i + 1),
                                canvas.value.height / 10
                            );
                            ctx.globalAlpha = 1;
                            ctx.font = `bold ${canvas.value.height / 16}px arial`;
                            ctx.fillStyle = '#ffffff';
                            ctx.fillText(
                                `${tarStr}: ${score}`,
                                (canvas.value.width / tagets.length) * i,
                                canvas.value.height / 16
                            );
                        }
                    }
                    if (data?.keypoints) {
                        const keypoints = data.keypoints;
                        for (let i = 0; i < keypoints.length; i += 1) {
                            const keypoint = keypoints[i];
                            const rect = keypoint[0];
                            const points = keypoint[1];
                            const pointSet = new Set();
                            // draw box
                            if (rect?.length === 6) {
                                const x = rect[0];
                                const y = rect[1];
                                const w = rect[2];
                                const h = rect[3];
                                const score = rect[4];
                                const tar = parseInt(rect[5], 10);
                                const color = COLORS[i % COLORS.length];
                                let tarStr = '';
                                tarStr = tar.toString();
                                ctx.strokeStyle = color;
                                ctx.lineWidth = 2;
                                ctx.strokeRect(x - w / 2, y - h / 2, w, h);
                                ctx.fillStyle = color;
                                ctx.fillRect(x - w / 2, y - h / 2 - 12, w, 12);
                                ctx.font = 'bold 12px arial';
                                ctx.fillStyle = '#ffffff';
                                ctx.fillText(`${tarStr}: ${score}`, x - w / 2 + 5, y - h / 2 - 2);
                            }
                            // fliter points
                            for (let j = 0; j < points.length; j += 1) {
                                const point = points[j];
                                const x = point[0];
                                const y = point[1];
                                const target = point[3];
                                // draw if point in the box
                                if (
                                    x > rect[0] - rect[2] / 2 &&
                                    x < rect[0] + rect[2] / 2 &&
                                    y > rect[1] - rect[3] / 2 &&
                                    y < rect[1] + rect[3] / 2
                                ) {
                                    pointSet.add(target);
                                }
                            }
                            // draw lines
                            if (points.length === 17) {
                                // human pose with 17 points
                                ctx.lineWidth = 2;

                                // nose to left eye
                                if (pointSet.has(0) && pointSet.has(1)) {
                                    ctx.strokeStyle = COLORS[0];
                                    ctx.beginPath();
                                    ctx.moveTo(points[0][0], points[0][1]);
                                    ctx.lineTo(points[1][0], points[1][1]);
                                    ctx.stroke();
                                }
                                // nose to right eye
                                if (pointSet.has(0) && pointSet.has(2)) {
                                    ctx.strokeStyle = COLORS[0];
                                    ctx.beginPath();
                                    ctx.moveTo(points[0][0], points[0][1]);
                                    ctx.lineTo(points[2][0], points[2][1]);
                                    ctx.stroke();
                                }

                                // left eye to left ear
                                if (pointSet.has(1) && pointSet.has(3)) {
                                    ctx.strokeStyle = COLORS[0];
                                    ctx.beginPath();
                                    ctx.moveTo(points[1][0], points[1][1]);
                                    ctx.lineTo(points[3][0], points[3][1]);
                                    ctx.stroke();
                                }

                                // right eye to right ear
                                if (pointSet.has(2) && pointSet.has(4)) {
                                    ctx.strokeStyle = COLORS[0];
                                    ctx.beginPath();
                                    ctx.moveTo(points[2][0], points[2][1]);
                                    ctx.lineTo(points[4][0], points[4][1]);
                                    ctx.stroke();
                                }

                                // left ear to left shoulder
                                if (pointSet.has(3) && pointSet.has(5)) {
                                    ctx.strokeStyle = COLORS[0];
                                    ctx.beginPath();
                                    ctx.moveTo(points[3][0], points[3][1]);
                                    ctx.lineTo(points[5][0], points[5][1]);
                                    ctx.stroke();
                                }

                                // right ear to right shoulder
                                if (pointSet.has(4) && pointSet.has(6)) {
                                    ctx.strokeStyle = COLORS[0];
                                    ctx.beginPath();
                                    ctx.moveTo(points[4][0], points[4][1]);
                                    ctx.lineTo(points[6][0], points[6][1]);
                                    ctx.stroke();
                                }

                                // left shoulder to right shoulder
                                if (pointSet.has(5) && pointSet.has(6)) {
                                    ctx.strokeStyle = COLORS[1];
                                    ctx.beginPath();
                                    ctx.moveTo(points[5][0], points[5][1]);
                                    ctx.lineTo(points[6][0], points[6][1]);
                                    ctx.stroke();
                                }

                                // left shoulder to left hip
                                if (pointSet.has(5) && pointSet.has(11)) {
                                    ctx.strokeStyle = COLORS[2];
                                    ctx.beginPath();
                                    ctx.moveTo(points[5][0], points[5][1]);
                                    ctx.lineTo(points[11][0], points[11][1]);
                                    ctx.stroke();
                                }

                                // right shoulder to right hip
                                if (pointSet.has(6) && pointSet.has(12)) {
                                    ctx.strokeStyle = COLORS[2];
                                    ctx.beginPath();
                                    ctx.moveTo(points[6][0], points[6][1]);
                                    ctx.lineTo(points[12][0], points[12][1]);
                                    ctx.stroke();
                                }

                                // left hip to right hip
                                if (pointSet.has(11) && pointSet.has(12)) {
                                    ctx.strokeStyle = COLORS[2];
                                    ctx.beginPath();
                                    ctx.moveTo(points[11][0], points[11][1]);
                                    ctx.lineTo(points[12][0], points[12][1]);
                                    ctx.stroke();
                                }

                                // left shoulder to left elbow
                                if (pointSet.has(5) && pointSet.has(7)) {
                                    ctx.strokeStyle = COLORS[1];
                                    ctx.beginPath();
                                    ctx.moveTo(points[5][0], points[5][1]);
                                    ctx.lineTo(points[7][0], points[7][1]);
                                    ctx.stroke();
                                }

                                // left elbow to left wrist
                                if (pointSet.has(7) && pointSet.has(9)) {
                                    ctx.strokeStyle = COLORS[1];
                                    ctx.beginPath();
                                    ctx.moveTo(points[7][0], points[7][1]);
                                    ctx.lineTo(points[9][0], points[9][1]);
                                    ctx.stroke();
                                }

                                // right shoulder to right elbow
                                if (pointSet.has(6) && pointSet.has(8)) {
                                    ctx.strokeStyle = COLORS[1];
                                    ctx.beginPath();
                                    ctx.moveTo(points[6][0], points[6][1]);
                                    ctx.lineTo(points[8][0], points[8][1]);
                                    ctx.stroke();
                                }

                                // right elbow to right wrist
                                if (pointSet.has(8) && pointSet.has(10)) {
                                    ctx.strokeStyle = COLORS[1];
                                    ctx.beginPath();
                                    ctx.moveTo(points[8][0], points[8][1]);
                                    ctx.lineTo(points[10][0], points[10][1]);
                                    ctx.stroke();
                                }

                                // left hip to left knee
                                if (pointSet.has(11) && pointSet.has(13)) {
                                    ctx.strokeStyle = COLORS[3];
                                    ctx.beginPath();
                                    ctx.moveTo(points[11][0], points[11][1]);
                                    ctx.lineTo(points[13][0], points[13][1]);
                                    ctx.stroke();
                                }

                                // left knee to left ankle
                                if (pointSet.has(13) && pointSet.has(15)) {
                                    ctx.strokeStyle = COLORS[3];
                                    ctx.beginPath();
                                    ctx.moveTo(points[13][0], points[13][1]);
                                    ctx.lineTo(points[15][0], points[15][1]);
                                    ctx.stroke();
                                }

                                // right hip to right knee
                                if (pointSet.has(12) && pointSet.has(14)) {
                                    ctx.strokeStyle = COLORS[3];
                                    ctx.beginPath();
                                    ctx.moveTo(points[12][0], points[12][1]);
                                    ctx.lineTo(points[14][0], points[14][1]);
                                    ctx.stroke();
                                }

                                // right knee to right ankle
                                if (pointSet.has(14) && pointSet.has(16)) {
                                    ctx.strokeStyle = COLORS[3];
                                    ctx.beginPath();
                                    ctx.moveTo(points[14][0], points[14][1]);
                                    ctx.lineTo(points[16][0], points[16][1]);
                                    ctx.stroke();
                                }
                            }

                            if (points.length === 21) {
                                // hand 21 points
                                ctx.lineWidth = 2;

                                // thumb
                                if (pointSet.has(0) && pointSet.has(1)) {
                                    ctx.strokeStyle = COLORS[0];
                                    ctx.beginPath();
                                    ctx.moveTo(points[0][0], points[0][1]);
                                    ctx.lineTo(points[1][0], points[1][1]);
                                    ctx.stroke();
                                }

                                if (pointSet.has(1) && pointSet.has(2)) {
                                    ctx.strokeStyle = COLORS[0];
                                    ctx.beginPath();
                                    ctx.moveTo(points[1][0], points[1][1]);
                                    ctx.lineTo(points[2][0], points[2][1]);
                                    ctx.stroke();
                                }

                                if (pointSet.has(2) && pointSet.has(3)) {
                                    ctx.strokeStyle = COLORS[0];
                                    ctx.beginPath();
                                    ctx.moveTo(points[2][0], points[2][1]);
                                    ctx.lineTo(points[3][0], points[3][1]);
                                    ctx.stroke();
                                }

                                if (pointSet.has(3) && pointSet.has(4)) {
                                    ctx.strokeStyle = COLORS[0];
                                    ctx.beginPath();
                                    ctx.moveTo(points[3][0], points[3][1]);
                                    ctx.lineTo(points[4][0], points[4][1]);
                                    ctx.stroke();
                                }

                                // index finger
                                if (pointSet.has(0) && pointSet.has(5)) {
                                    ctx.strokeStyle = COLORS[1];
                                    ctx.beginPath();
                                    ctx.moveTo(points[0][0], points[0][1]);
                                    ctx.lineTo(points[5][0], points[5][1]);
                                    ctx.stroke();
                                }
                                if (pointSet.has(5) && pointSet.has(6)) {
                                    ctx.strokeStyle = COLORS[1];
                                    ctx.beginPath();
                                    ctx.moveTo(points[5][0], points[5][1]);
                                    ctx.lineTo(points[6][0], points[6][1]);
                                    ctx.stroke();
                                }

                                if (pointSet.has(6) && pointSet.has(7)) {
                                    ctx.strokeStyle = COLORS[1];
                                    ctx.beginPath();
                                    ctx.moveTo(points[6][0], points[6][1]);
                                    ctx.lineTo(points[7][0], points[7][1]);
                                    ctx.stroke();
                                }

                                if (pointSet.has(7) && pointSet.has(8)) {
                                    ctx.strokeStyle = COLORS[1];
                                    ctx.beginPath();
                                    ctx.moveTo(points[7][0], points[7][1]);
                                    ctx.lineTo(points[8][0], points[8][1]);
                                    ctx.stroke();
                                }

                                // middle finger
                                if (pointSet.has(5) && pointSet.has(9)) {
                                    ctx.strokeStyle = COLORS[5];
                                    ctx.beginPath();
                                    ctx.moveTo(points[5][0], points[5][1]);
                                    ctx.lineTo(points[9][0], points[9][1]);
                                    ctx.stroke();
                                }
                                if (pointSet.has(9) && pointSet.has(10)) {
                                    ctx.strokeStyle = COLORS[2];
                                    ctx.beginPath();
                                    ctx.moveTo(points[9][0], points[9][1]);
                                    ctx.lineTo(points[10][0], points[10][1]);
                                    ctx.stroke();
                                }

                                if (pointSet.has(10) && pointSet.has(11)) {
                                    ctx.strokeStyle = COLORS[2];
                                    ctx.beginPath();
                                    ctx.moveTo(points[10][0], points[10][1]);
                                    ctx.lineTo(points[11][0], points[11][1]);
                                    ctx.stroke();
                                }

                                if (pointSet.has(11) && pointSet.has(12)) {
                                    ctx.strokeStyle = COLORS[2];
                                    ctx.beginPath();
                                    ctx.moveTo(points[11][0], points[11][1]);
                                    ctx.lineTo(points[12][0], points[12][1]);
                                    ctx.stroke();
                                }

                                // ring finger
                                if (pointSet.has(9) && pointSet.has(13)) {
                                    ctx.strokeStyle = COLORS[5];
                                    ctx.beginPath();
                                    ctx.moveTo(points[9][0], points[9][1]);
                                    ctx.lineTo(points[13][0], points[13][1]);
                                    ctx.stroke();
                                }

                                if (pointSet.has(13) && pointSet.has(14)) {
                                    ctx.strokeStyle = COLORS[3];
                                    ctx.beginPath();
                                    ctx.moveTo(points[13][0], points[13][1]);
                                    ctx.lineTo(points[14][0], points[14][1]);
                                    ctx.stroke();
                                }

                                if (pointSet.has(14) && pointSet.has(15)) {
                                    ctx.strokeStyle = COLORS[3];
                                    ctx.beginPath();
                                    ctx.moveTo(points[14][0], points[14][1]);
                                    ctx.lineTo(points[15][0], points[15][1]);
                                    ctx.stroke();
                                }

                                if (pointSet.has(15) && pointSet.has(16)) {
                                    ctx.strokeStyle = COLORS[3];
                                    ctx.beginPath();
                                    ctx.moveTo(points[15][0], points[15][1]);
                                    ctx.lineTo(points[16][0], points[16][1]);
                                    ctx.stroke();
                                }

                                // pinky
                                if (pointSet.has(13) && pointSet.has(17)) {
                                    ctx.strokeStyle = COLORS[5];
                                    ctx.beginPath();
                                    ctx.moveTo(points[13][0], points[13][1]);
                                    ctx.lineTo(points[17][0], points[17][1]);
                                    ctx.stroke();
                                }
                                if (pointSet.has(0) && pointSet.has(17)) {
                                    ctx.strokeStyle = COLORS[4];
                                    ctx.beginPath();
                                    ctx.moveTo(points[0][0], points[0][1]);
                                    ctx.lineTo(points[17][0], points[17][1]);
                                    ctx.stroke();
                                }

                                if (pointSet.has(17) && pointSet.has(18)) {
                                    ctx.strokeStyle = COLORS[4];
                                    ctx.beginPath();
                                    ctx.moveTo(points[17][0], points[17][1]);
                                    ctx.lineTo(points[18][0], points[18][1]);
                                    ctx.stroke();
                                }

                                if (pointSet.has(18) && pointSet.has(19)) {
                                    ctx.strokeStyle = COLORS[4];
                                    ctx.beginPath();
                                    ctx.moveTo(points[18][0], points[18][1]);
                                    ctx.lineTo(points[19][0], points[19][1]);
                                    ctx.stroke();
                                }

                                if (pointSet.has(19) && pointSet.has(20)) {
                                    ctx.strokeStyle = COLORS[4];
                                    ctx.beginPath();
                                    ctx.moveTo(points[19][0], points[19][1]);
                                    ctx.lineTo(points[20][0], points[20][1]);
                                    ctx.stroke();
                                }
                            }

                            // draw points
                            for (let j = 0; j < points.length; j += 1) {
                                const point = points[j];
                                const x = point[0];
                                const y = point[1];
                                const target = point[3];
                                if (pointSet.has(target)) {
                                    ctx.fillStyle = COLORS[target % COLORS.length];
                                    ctx.beginPath();
                                    ctx.arc(x, y, 3, 0, 3 * Math.PI);
                                    ctx.fill();
                                }
                            }
                        }
                    }
                };
                img.src = `data:image/jpg;base64,${image}`;
            }
        }
    </script>
</body>

</html>